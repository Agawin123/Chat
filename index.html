<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Chat</title>
<style>
:root {
  --bg: #031b36;
  --card: #082a52;
  --text: #cce6ff;
  --bubble: #0a336b;
  --bubble-2: #0e4a91;
}
body {
  font-family: Arial;
  background-color: var(--bg);
  color: var(--text);
  margin:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  height:100vh;
  overflow:hidden;
}
#loginContainer, #chatContainer, #dmContainer {
  background-color: var(--card);
  border-radius:16px;
  box-shadow:0 0 15px #0b68d8;
  padding:20px;
  width:80%;
  max-width:600px;
  margin-top:40px;
}
input, button, select {
  padding:8px;
  border-radius:8px;
  border:none;
  margin:5px;
}
button {
  background-color:#007bff;
  color:white;
  cursor:pointer;
}
button:hover {
  background-color:#00aaff;
}
#messages {
  height:300px;
  overflow-y:auto;
  border:1px solid #0852a3;
  padding:10px;
  margin-bottom:10px;
  background-color:#041a35;
  border-radius:10px;
}
.message {
  margin:5px 0;
}
.bubble {
  background: linear-gradient(180deg,var(--bubble),var(--bubble-2));
  padding:10px;
  border-radius:10px;
  max-width:45%;
  box-shadow:0 6px 18px rgba(3,27,54,0.5);
  color: var(--text);
  border:1px solid rgba(11,104,216,0.06);
  word-wrap:break-word;
  margin-top:3px;
}
#onlineUsers {
  position:absolute;
  top:10px;
  right:10px;
  background: var(--bubble);
  padding:10px;
  border-radius:10px;
  color:#aaccff;
  font-size:14px;
}
#channels {
  position:absolute;
  top:60px;
  right:10px;
  background: var(--bubble);
  padding:10px;
  border-radius:10px;
  color:#aaccff;
  font-size:14px;
  max-height:60vh;
  overflow-y:auto;
}
.channelBtn {
  display:block;
  background-color: var(--bubble);
  color: var(--text);
  border-radius:8px;
  margin:3px 0;
  padding:5px;
  cursor:pointer;
}
.channelBtn:hover {
  background-color: var(--bubble-2);
}
img.chatImage {
  max-width:150px;
  border-radius:8px;
  margin-top:5px;
}
</style>
</head>
<body>

<div id="onlineUsers">Online: Loading...</div>
<div id="channels">Channels:<div id="dmListContainer"></div></div>

<div id="loginContainer">
  <h2>Login or Create Account</h2>
  <input id="username" placeholder="Username"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="createAccount()">Create Account</button>
  <button onclick="login()">Login</button>
  <p id="loginMsg"></p>
</div>

<div id="chatContainer" style="display:none;">
  <h2 id="welcome"></h2>
  <div id="messages"></div>
  <input id="msgInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter') sendMessage()">
  <button onclick="sendMessage()">Send</button>
  <button onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
  <input type="file" id="imageInput" accept="image/*" style="display:none">
  <p id="statusMsg"></p>
</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbywhKqysxY6aGRfNNqIHW3C3ZaEoq7F0mLqOBVdjwi2YZcJkL6bJ-iokAel0L1dLLMN/exec"; // replace with the URL from redeploy

let currentUser = "";
let currentChannel = "Main";
let approved = false;
let messagePollTimeout = null;

// ===== ACCOUNT LOGIC =====
async function createAccount() {
  const user = username.value.trim();
  const pass = password.value.trim();
  if (!user || !pass) return loginMsg.textContent = "Enter username & password.";

  try {
    const res = await fetch(`${BASE_URL}?action=createAccount&username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`);
    const text = await res.text();
    loginMsg.textContent = text;
  } catch(err) {
    console.error(err);
    loginMsg.textContent = "Error connecting to server.";
  }
}

async function login() {
  const user = username.value.trim();
  const pass = password.value.trim();
  if (!user || !pass) return loginMsg.textContent = "Enter username & password.";

  try {
    const res = await fetch(`${BASE_URL}?action=login&username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`);
    const text = await res.text();

    if(text === "Login success") {
      currentUser = user;
      approved = true;
      startChat();
    } else {
      loginMsg.textContent = text;
    }
  } catch(err) {
    console.error(err);
    loginMsg.textContent = "Error connecting to server.";
  }
}

// ===== CHAT START =====
function startChat() {
  loginContainer.style.display = "none";
  chatContainer.style.display = "block";
  welcome.textContent = "Logged in as " + currentUser;
  loadUsers();
  loadChannels();
  startMessagePolling();
  startUserPolling();
}

// ===== POLLING HELPERS =====
function startMessagePolling() {
  if(messagePollTimeout) clearTimeout(messagePollTimeout);
  const poll = async () => {
    await loadMessages();
    messagePollTimeout = setTimeout(poll, 3000);
  };
  poll();
}

function startUserPolling() {
  setInterval(loadUsers, 5000);
}

// ===== LOAD USERS =====
async function loadUsers() {
  if(!approved) return;
  try {
    const res = await fetch(`${BASE_URL}?action=getUsers`);
    const online = await res.json();
    onlineUsers.textContent = "Online: "+(online.length ? online.join(", ") : "None");
  } catch(err) {
    console.error(err);
  }
}

// ===== LOAD CHANNELS =====
async function loadChannels() {
  if(!approved) return;
  try {
    const usersRes = await fetch(`${BASE_URL}?action=getUsers`);
    const users = await usersRes.json();
    const container = document.getElementById("dmListContainer");
    container.innerHTML = "";
    users.forEach(u => {
      if(u !== currentUser){
        const btn = document.createElement("div");
        btn.className = "channelBtn";
        btn.textContent = "#" + u;
        btn.onclick = () => openDM(u);
        container.appendChild(btn);
      }
    });
  } catch(err) {
    console.error(err);
  }
}

// ===== OPEN DM =====
async function openDM(otherUser){
  const dmChannel = [currentUser, otherUser].sort().join("_DM_");
  await fetch(`${BASE_URL}?action=createDMChannel&user1=${encodeURIComponent(currentUser)}&user2=${encodeURIComponent(otherUser)}`);
  currentChannel = dmChannel;
  await loadMessages();
  startMessagePolling();
}

// ===== LOAD MESSAGES =====
async function loadMessages(){
  if(!approved) return;
  try {
    const res = await fetch(`${BASE_URL}?action=getMessages&channel=${encodeURIComponent(currentChannel)}`);
    const data = await res.json();
    const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 50;
    messages.innerHTML = "";

    data.forEach(d => {
      const div = document.createElement("div");
      div.className = "message";

      const info = document.createElement("div");
      info.textContent = `${d.time} ${d.sender}`;
      div.appendChild(info);

      if(d.message){
        const msg = document.createElement("div");
        msg.className = "bubble";
        msg.textContent = d.message;
        div.appendChild(msg);
      }
      if(d.imageUrl){
        const img = document.createElement("img");
        img.className = "chatImage";
        img.src = d.imageUrl;
        div.appendChild(img);
      }

      messages.appendChild(div);
    });

    if(atBottom) messages.scrollTop = messages.scrollHeight;
  } catch(err) {
    console.error(err);
  }
}

// ===== SEND MESSAGE =====
async function sendMessage(){
  const msg = msgInput.value.trim();
  if(!msg) return;
  try {
    await fetch(`${BASE_URL}?action=sendMessage&channel=${encodeURIComponent(currentChannel)}&sender=${encodeURIComponent(currentUser)}&message=${encodeURIComponent(msg)}`);
    msgInput.value = "";
    await loadMessages();
  } catch(err){
    console.error(err);
    statusMsg.textContent = "Error sending message.";
  }
}

// ===== UPLOAD IMAGE =====
document.getElementById("imageInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if(!file) return;

  if(file.size > 5*1024*1024){
    statusMsg.textContent = "File too big!";
    return;
  }

  const reader = new FileReader();
  reader.onload = async function(){
    const base64 = reader.result.split(",")[1];
    try {
      const formData = new FormData();
      formData.append("action", "uploadImage");
      formData.append("channel", currentChannel);
      formData.append("sender", currentUser);
      formData.append("file", base64);

      const res = await fetch(BASE_URL, { method: "POST", body: formData });
      const json = await res.json();

      if(json.success){
        statusMsg.textContent = "Image uploaded!";
        await loadMessages();
      } else {
        statusMsg.textContent = "Upload failed: " + json.error;
      }
    } catch(err){
      console.error(err);
      statusMsg.textContent = "Upload error";
    }
  };
  reader.readAsDataURL(file);
});
</script>

</body>
</html>
